---
import "../styles/projects.css";

const { copy } = Astro.props;

const APP_LINK_PROTOCOLS = ["mailto:", "tel:", "sms:", "geo:"];
const APP_LINK_HOSTS = [
  "linkedin.com",
  "github.com",
  "instagram.com",
  "facebook.com",
  "x.com",
  "twitter.com",
  "youtube.com",
  "wa.me",
  "whatsapp.com",
  "t.me",
  "telegram.me",
  "open.spotify.com",
];

const shouldPreferSameTab = (href = "") => {
  const normalized = href.trim().toLowerCase();
  if (!normalized) {
    return false;
  }

  if (APP_LINK_PROTOCOLS.some((protocol) => normalized.startsWith(protocol))) {
    return true;
  }

  try {
    const url = new URL(href);
    const host = url.hostname.toLowerCase().replace(/^www\./, "");
    return APP_LINK_HOSTS.some(
      (domain) => host === domain || host.endsWith(`.${domain}`)
    );
  } catch {
    return false;
  }
};
---
<section id="projects" class="Proyects-container">
  <div class="Proyects-title">
    <h2>{copy.projects.title}</h2>
  </div>
  <div class="Projects-list">
    {copy.projects.items.map((project, index) => {
      const hasLinks = Boolean(project.liveUrl || project.repoUrl);
      const liveInNewTab = project.liveUrl
        ? !shouldPreferSameTab(project.liveUrl)
        : false;
      const repoInNewTab = project.repoUrl
        ? !shouldPreferSameTab(project.repoUrl)
        : false;
      return (
        <article class={`project-row ${index % 2 !== 0 ? "project-row-reverse" : ""}`}>
          {project.liveUrl ? (
            <a
              class="project-visual"
              href={project.liveUrl}
              target={liveInNewTab ? "_blank" : undefined}
              rel={liveInNewTab ? "noreferrer noopener" : undefined}
              aria-label={`${project.title} live`}
            >
              <img class="project-image" src={project.image} alt={project.imageAlt} loading="lazy" />
            </a>
          ) : (
            <div class="project-visual">
              <img class="project-image" src={project.image} alt={project.imageAlt} loading="lazy" />
            </div>
          )}
          <div class="project-info">
            <h3 class="project-title">{project.title}</h3>
            <div class="project-tech">
              {project.tech.map((tech) => {
                const isSwift = tech.toLowerCase() === "swift";
                return (
                  <span class="tech-pill">
                    {isSwift && <i class="bx bx-sm bxl-apple" aria-hidden="true"></i>}
                    <span>{tech}</span>
                  </span>
                );
              })}
            </div>
            <p class="project-description">{project.description}</p>
            {hasLinks && (
              <div class="project-links">
                {project.repoUrl && (
                  <a
                    class="project-link project-link-code"
                    href={project.repoUrl}
                    target={repoInNewTab ? "_blank" : undefined}
                    rel={repoInNewTab ? "noreferrer noopener" : undefined}
                    aria-label={`${project.title} repository`}
                  >
                    <i class="bx bx-sm bxl-github"></i>
                    <span>{copy.projects.repoLabel}</span>
                  </a>
                )}
                {project.liveUrl && (
                  <a
                    class="project-link"
                    href={project.liveUrl}
                    target={liveInNewTab ? "_blank" : undefined}
                    rel={liveInNewTab ? "noreferrer noopener" : undefined}
                    aria-label={`${project.title} live`}
                  >
                    <i class="bx bx-sm bx-link-alt"></i>
                    <span>{copy.projects.liveLabel}</span>
                  </a>
                )}
              </div>
            )}
          </div>
        </article>
      );
    })}
  </div>
</section>
